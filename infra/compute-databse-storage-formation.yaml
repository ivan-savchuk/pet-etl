AWSTemplateFormatVersion: "2010-09-09"
Description: "Resources for Compute, Database and Storage in pet-etl project"

Parameters:
  DBPassword:
    Description: "Enter the password for the database"
    Type: "String"
    NoEcho: "true"

Resources:
  LambdaCodeBucket:
    Type: "AWS::S3::Bucket"
    Properties:
      BucketName: "pet-etl-lambda-code-storage"
      Tags:
        - Key: "project"
          Value: "pet-etl"

  RawDataBucket:
    Type: "AWS::S3::Bucket"
    Properties:
      BucketName: "pet-etl-raw-data-storage"
      Tags:
        - Key: "project"
          Value: "pet-etl"

  PetEtlDBSecurityGroup:
    Type: "AWS::RDS::DBSecurityGroup"
    Properties:
      Tags:
        - Key: "project"
          Value: "pet-etl"
      GroupDescription: "Allow access to the RDS instance"
      DBSecurityGroupIngress:
        - CIDRIP: "0.0.0.0/0"

  PetEtlDBInstance:
    Type: "AWS::RDS::DBInstance"
    Description: "RDS instance for pet-etl project"
    Properties:
      AllocatedStorage: "20"
      DBInstanceClass: "db.t3.micro"
      Engine: "postgres"
      EngineVersion: "14.7"
      DBInstanceIdentifier: "PetEtlDBInstance"
      MasterUsername: "postgres"
      MasterUserPassword: !Sub "${DBPassword}"
      DBSecurityGroups:
        - !Ref "PetEtlDBSecurityGroup"
      PubliclyAccessible: "true"
      Tags:
        - Key: "project"
          Value: "pet-etl"

Outputs:
  DBEndpoint:
    Value: !GetAtt "PetEtlDBInstance.Endpoint.Address"
    Description: "Endpoint for the created RDS instance"
